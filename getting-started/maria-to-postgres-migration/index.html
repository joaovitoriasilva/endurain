<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>MariaDB to Postgres migration - Endurain documentation</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" disabled>
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Endurain documentation</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Hosting Guide</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../getting-started/" class="dropdown-item">Getting started easy</a>
</li>
                                    
<li>
    <a href="../advanced-started/" class="dropdown-item">Getting started advanced</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">MariaDB to Postgres migration</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Integrations</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../integrations/3rd-party-apps/" class="dropdown-item">3rd party apps</a>
</li>
                                    
<li>
    <a href="../../integrations/3rd-party-services/" class="dropdown-item">3rd party services</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="../../developer-guide/" class="nav-link">Developer guide</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../gallery/" class="nav-link">Gallery</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../advanced-started/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../integrations/3rd-party-apps/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/joaovitoriasilva/endurain/edit/master/docs/getting-started/maria-to-postgres-migration.md" class="nav-link"><i class="fa-brands fa-github"></i> Edit on GitHub</a>
                            </li>
                            <li class="nav-item dropdown">
                              <button id="theme-menu" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme" class="nav-link dropdown-toggle">
                                <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                <span class="d-lg-none ms-2">Toggle theme</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                                    <i class="fa-solid fa-sun fa-fw"></i>
                                    <span class="ms-2">Light</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                                    <i class="fa-solid fa-moon fa-fw"></i>
                                    <span class="ms-2">Dark</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto" aria-pressed="true">
                                    <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                    <span class="ms-2">Auto</span>
                                    <i class="fa-solid fa-check ms-auto"></i>
                                  </button>
                                </li>
                              </ul>
                            </li>
                    </ul>
                </div>
            </div>
        </div>
        <script src="../../js/darkmode.js"></script>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#mariadb-to-postgres-migration-guide" class="nav-link">MariaDB to Postgres migration guide</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#install-pgloader" class="nav-link">Install pgloader</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#migration-steps" class="nav-link">Migration steps</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#mariadb-dump-backup-options" class="nav-link">MariaDB dump backup options</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#option-1-run-mysqldump-mariadb-dump-from-the-host" class="nav-link">Option 1: Run mysqldump / mariadb-dump from the host</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#option-2-use-a-temporary-mariadb-client-container" class="nav-link">Option 2: Use a temporary MariaDB client container</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#option-3-install-mariadb-client-inside-the-existing-container" class="nav-link">Option 3: Install mariadb-client inside the existing container</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#postgres-preparation-for-pgloader" class="nav-link">Postgres preparation for pgloader</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#do-the-migration" class="nav-link">Do the migration</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#prerequisites-and-important-notes" class="nav-link">Prerequisites and Important Notes</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#migration-process" class="nav-link">Migration Process</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#revert-postgres-changes" class="nav-link">Revert Postgres changes</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#troubleshooting-common-issues" class="nav-link">Troubleshooting Common Issues</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="mariadb-to-postgres-migration-guide">MariaDB to Postgres migration guide</h1>
<p>This will guide you on how to migrate from MariaDB to Postgres. Endurain will drop support for MariaDB on v0.16.0, so you'll need to perform this migration prior to upgrade to v0.16.0
This guide uses <a href="https://pgloader.io">pgloader</a> to automate the migration.
This guide uses some <a href="https://github.com/joaovitoriasilva/endurain/tree/master/docs">helper files</a>. Refer to them when needed.</p>
<h1 id="install-pgloader">Install pgloader</h1>
<p>Refer to <a href="https://pgloader.readthedocs.io/en/latest/">pgloader docs</a> for installation instructions.</p>
<h1 id="migration-steps">Migration steps</h1>
<ul>
<li>Stop Endurain container;</li>
</ul>
<pre><code class="language-bash">docker compose down
</code></pre>
<ul>
<li>Backup existent database - <a href="#mariadb-dump-backup-options">MariaDB dump backup options</a>;</li>
<li>Run pgloader to do the migration - <a href="#do-the-migration">Do the migration</a>;</li>
<li>Verify migration by:<ul>
<li>Checking pgloader outputs and logs.</li>
</ul>
</li>
<li>Update environment variables (adapt to your environment):</li>
</ul>
<pre><code class="language-bash">DB_TYPE=postgres
DB_HOST=postgres
DB_PORT=5432
</code></pre>
<ul>
<li>Start with PostgreSQL:</li>
</ul>
<pre><code class="language-bash">docker compose up -d
</code></pre>
<ul>
<li>Monitor logs for any issues;</li>
<li>Verify application functionality:<ul>
<li>Test login;</li>
<li>Upload test activity;</li>
<li>Check activity streams display;</li>
<li>Verify integrations (Strava, Garmin);</li>
<li>Others.</li>
</ul>
</li>
</ul>
<h1 id="mariadb-dump-backup-options">MariaDB dump backup options</h1>
<h2 id="option-1-run-mysqldump-mariadb-dump-from-the-host">Option 1: Run <code>mysqldump</code> / <code>mariadb-dump</code> from the host</h2>
<p>Run the dump from your host machine (Ubuntu) using the MySQL or MariaDB client tools installed locally. You need to adjust host, port, database and password to match your environment.</p>
<pre><code class="language-bash">mysqldump -h 127.0.0.1 -P 3306 -u endurain -p'redacted' endurain \
&gt; final_backup_$(date +%Y%m%d_%H%M%S).sql
</code></pre>
<pre><code class="language-bash">mariadb-dump -h 127.0.0.1 -P 3306 -u endurain -p'redacted' endurain \
&gt; final_backup_$(date +%Y%m%d_%H%M%S).sql
</code></pre>
<p><strong>Pros:</strong></p>
<ul>
<li>No need to modify the container  </li>
<li>Easy to automate in cron or scripts  </li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li>Requires MariaDB client installed on the host</li>
<li>The container’s database port must be exposed</li>
</ul>
<h2 id="option-2-use-a-temporary-mariadb-client-container">Option 2: Use a temporary MariaDB client container</h2>
<p>Use a one-time client container that connects to your running MariaDB instance. You need to adjust container name, host, port, database and password to match your environment.</p>
<pre><code class="language-bash">sudo docker run --rm \
  --network container:mariadb_endurain_prod \
  mariadb:latest \
  mariadb-dump -h127.0.0.1 -u endurain -p'redacted' endurain \
  &gt; final_backup_$(date +%Y%m%d_%H%M%S).sql
</code></pre>
<p><strong>Pros:</strong></p>
<ul>
<li>Doesn’t modify your running container</li>
<li>Uses an official image that already includes <code>mariadb-dump</code></li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li>Slightly longer to run (needs to pull/start the client container)</li>
</ul>
<h2 id="option-3-install-mariadb-client-inside-the-existing-container">Option 3: Install <code>mariadb-client</code> inside the existing container</h2>
<p>If you prefer to back up directly from inside the existing MariaDB container, install the client tools and use <code>mariadb-dump</code>.</p>
<h3 id="installation">Installation</h3>
<p>Connect to the container shell and do:</p>
<ul>
<li>For Debian/Ubuntu-based containers:</li>
</ul>
<pre><code class="language-bash">apt-get update &amp;&amp; apt-get install -y mariadb-client
</code></pre>
<ul>
<li>For Alpine-based containers:</li>
</ul>
<pre><code class="language-bash">apk add --no-cache mariadb-client
</code></pre>
<h3 id="backup-command-single-database-no-gtid">Backup Command (Single Database, No GTID)</h3>
<p>You need to adjust container name, host, port, database and password to match your environment.</p>
<pre><code class="language-bash">sudo docker exec mariadb_endurain_prod sh -lc \
&quot;mariadb-dump -u endurain -p'redacted' \
  --databases endurain \
  --single-transaction --routines --triggers --events --hex-blob&quot; \
&gt; final_backup_$(date +%Y%m%d_%H%M%S).sql
</code></pre>
<p><strong>Pros:</strong></p>
<ul>
<li>All-in-one (runs inside the existing container)</li>
<li>Direct socket access to MariaDB</li>
</ul>
<p><strong>Cons:</strong></p>
<ul>
<li>You modify the production container</li>
<li>Must remember to reinstall client tools after container rebuilds</li>
</ul>
<h1 id="postgres-preparation-for-pgloader">Postgres preparation for pgloader</h1>
<p>Postgres dropped support for MD5 hashed passwords in favor of SHA256, however pgloader <a href="https://github.com/dimitri/pgloader/issues/1207">does not support SHA256</a>. What I did was:</p>
<ul>
<li>Change password to be MD5 hashed:</li>
</ul>
<pre><code class="language-sql">set password_encryption to 'md5';
ALTER ROLE endurain password 'JUST_RETYPE_YOUR_EXISTING_PASSWORD';
</code></pre>
<ul>
<li>Change <code>pg_hba.conf</code> file to allow MD5 logins:<ul>
<li>On my machine using postgres 18 Docker image: <code>/opt/containers/postgres_endurain_prod/18/docker/pg_hba.conf</code></li>
</ul>
</li>
</ul>
<pre><code class="language-bash"># replication privilege.
local   replication     all                                     trust
host    replication     all             127.0.0.1/32            trust
host    replication     all             ::1/128                 trust

# Allow MD5 just for endurain (IPv4 example). # Add this line
host    all     endurain   0.0.0.0/0     md5  # Add this line

host all all all scram-sha-256
</code></pre>
<h1 id="do-the-migration">Do the migration</h1>
<h2 id="prerequisites-and-important-notes">Prerequisites and Important Notes</h2>
<p>⚠️ <strong>Important Notes:</strong></p>
<ul>
<li>DB passwords with special characters like <code>@</code> or <code>!</code> can cause issues;</li>
<li>Recommendation: Use simple passwords during migration, change them afterward;</li>
<li>The migration can be memory-intensive, especially for large <code>activities_streams</code> tables;</li>
<li>Ensure sufficient RAM (at least 4GB available) on the machine running pgloader.</li>
</ul>
<h2 id="migration-process">Migration Process</h2>
<p>Remember: Always keep your MariaDB backup until you're confident the PostgreSQL migration is successful and stable.</p>
<p>After <a href="https://pgloader.readthedocs.io/en/latest/">pgloader</a> is installed:</p>
<h3 id="clone-endurain-repository">Clone Endurain repository</h3>
<pre><code class="language-bash">git clone https://github.com/joaovitoriasilva/endurain
cd endurain/mariadb_to_postgres
</code></pre>
<h3 id="edit-the-migration-configuration">Edit the migration configuration</h3>
<ul>
<li>Edit <code>mariadb_to_postgres_streams_only.load</code> and <code>mariadb_to_postgres_without_streams.load</code> to match your environment;</li>
<li>Change DB connections (adjust host, port, database, user and password).</li>
</ul>
<pre><code class="language-sql">LOAD DATABASE
    FROM mysql://endurain:password@mariadb-host:3306/endurain
    INTO postgresql://endurain:password@postgres-host:5432/endurain
</code></pre>
<h3 id="migration">Migration</h3>
<p>The migration is splitted because activity_streams table has large json data, causing memory issues:</p>
<ul>
<li><strong>Step 1:</strong> Migrate all tables except activities_streams:</li>
</ul>
<pre><code class="language-bash">pgloader --verbose --load-lisp-file transforms.lisp mariadb_to_postgres_without_streams.load &gt; migration_main_$(date +%Y%m%d_%H%M%S).log 2&gt;&amp;1
</code></pre>
<ul>
<li><strong>Step 2:</strong> Migrate activities_streams separately:</li>
</ul>
<p>This step may take several minutes to conclude (1h+ in my case. You can try to ajust load file to increase speed).</p>
<pre><code class="language-bash">pgloader --verbose --load-lisp-file transforms.lisp mariadb_to_postgres_streams_only.load &gt; migration_streams_$(date +%Y%m%d_%H%M%S).log 2&gt;&amp;1
</code></pre>
<h2 id="revert-postgres-changes">Revert Postgres changes</h2>
<p>Revert changes made to user endurain:</p>
<ul>
<li>Change password to be SHA256 hashed:</li>
</ul>
<pre><code class="language-sql">set password_encryption to 'scram-sha-256';
ALTER ROLE endurain password 'JUST_RETYPE_YOUR_EXISTING_PASSWORD';
</code></pre>
<ul>
<li>Change <code>pg_hba.conf</code> file to allow MD5 logins:<ul>
<li>On my machine using postgres 18 Docker image: <code>/opt/containers/postgres_endurain_prod/18/docker/pg_hba.conf</code></li>
</ul>
</li>
</ul>
<pre><code class="language-bash"># replication privilege.
local   replication     all                                     trust
host    replication     all             127.0.0.1/32            trust
host    replication     all             ::1/128                 trust

# Allow MD5 just for endurain (IPv4 example). # Remove this line
host    all     endurain   0.0.0.0/0     md5  # Remove this line

host all all all scram-sha-256
</code></pre>
<h2 id="troubleshooting-common-issues">Troubleshooting Common Issues</h2>
<h3 id="memory-exhaustion-errors">Memory Exhaustion Errors</h3>
<p><strong>Symptoms:</strong> "Heap exhausted during allocation" errors, especially when processing <code>activities_streams</code> table.</p>
<p><strong>Solutions:</strong></p>
<ul>
<li><strong>Increase system memory</strong> or close other applications</li>
<li><strong>Reduce batch size</strong> in the .load file:</li>
</ul>
<pre><code class="language-bash">change bellow to minor, default is 10
rows per range = 10 
</code></pre>
<ul>
<li><strong>Reduce workers</strong> in the .load file:</li>
</ul>
<pre><code class="language-bash">workers = 1, concurrency = 1,
</code></pre>
<h3 id="postgresql-connection-issues">PostgreSQL Connection Issues</h3>
<p><strong>Symptoms:</strong> Connection refused or authentication errors.</p>
<p><strong>Solutions:</strong></p>
<ul>
<li>Verify PostgreSQL is running and accessible</li>
<li>Check password authentication method (use MD5, not SCRAM-SHA-256)</li>
<li>Verify <code>pg_hba.conf</code> allows connections from pgloader host</li>
</ul>
<h3 id="large-json-data-issues">Large JSON Data Issues</h3>
<p><strong>Symptoms:</strong> Errors processing <code>stream_waypoints</code> column in <code>activities_streams</code>.</p>
<p><strong>Solutions:</strong></p>
<ul>
<li>The updated <code>transforms.lisp</code> includes <code>stream-waypoints-to-jsonb</code> function</li>
<li>Use split migration approach for better memory management</li>
<li>Consider manual cleanup of very large JSON records before migration</li>
</ul>
<h3 id="migration-time-estimates">Migration Time Estimates</h3>
<ul>
<li><strong>Small databases</strong> (&lt; 1000 activities): 5-15 minutes</li>
<li><strong>Medium databases</strong> (1000-5000 activities): 15-60 minutes  </li>
<li><strong>Large databases</strong> (&gt; 5000 activities): 1+ hours</li>
</ul>
<p><strong>Monitoring Progress:</strong></p>
<ul>
<li>Monitor the log file: <code>tail -f migration_*.log</code></li>
<li>Check PostgreSQL logs for any issues</li>
<li>Monitor system memory usage during migration</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
